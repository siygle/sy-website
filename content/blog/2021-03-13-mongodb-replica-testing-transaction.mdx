---
title: 'ä½¿ç”¨ MongoDB Replica Set ä¾†æ¸¬è©¦ Transaction åŠŸèƒ½'
date: '2021-03-13'
tags: ['MongoDB', 'Database', 'Geek', '2021']
draft: false
summary: 'èªªä¾†æ…šæ„§ï¼Œä½†ç¾åœ¨æ‰ç®—ç¬¬ä¸€æ¬¡æ­£å¼ç”¨ä¸Š MongoDB çš„ Transaction åŠŸèƒ½ï¼Œåœ¨å…œå¼„çš„éç¨‹ä¸­ä¹Ÿè¨˜ä¸‹äº†ä¸€äº›è‡ªå®¶é‡åˆ°çš„å•é¡Œ'
layout: PostSimple
---

èªªä¾†æ…šæ„§ï¼Œä½†ç¾åœ¨æ‰ç®—ç¬¬ä¸€æ¬¡æ­£å¼ç”¨ä¸Š MongoDB çš„ Transaction åŠŸèƒ½ï¼Œåœ¨å…œå¼„çš„éç¨‹ä¸­ä¹Ÿè¨˜ä¸‹äº†ä¸€äº›è‡ªå®¶é‡åˆ°çš„å•é¡Œã€‚å° Transaction é‚„ä¸æ¸…æ¥šçš„å¯ä»¥åƒè€ƒä¸€ä¸‹ MongoDB æ–‡ä»¶çš„ä»‹ç´¹ï¼Œä¸€èˆ¬ transaction æœƒç”¨åˆ°ä¸€é€£ä¸²çš„ IO è¡Œç‚ºï¼Œè€Œä¸”ä½ å¸Œæœ›èƒ½ç¢ºä¿è¡Œç‚ºçš„ä¸€è‡´æ€§ï¼Œä¹Ÿå°±æ˜¯èªªä½ åšäº† Aã€Bã€C ä¸‰å€‹è¡Œç‚ºï¼Œä¸€æ—¦å…¶ä¸­çš„æŸè™•ç™¼ç”Ÿå•é¡Œï¼Œä½ å¸Œæœ›ä¸æœƒç™¼ç”Ÿã€Œéƒ¨åˆ†è³‡æ–™å¯«å…¥ã€çš„æƒ…æ³ç™¼ç”Ÿï¼Œé€™æ™‚å€™ transaction å°±æ´¾ä¸Šç”¨å ´ï¼Œç›´åˆ°ç¢ºå®šæ‰€æœ‰è¡Œç‚ºéƒ½æ­£å¸¸åŸ·è¡Œå®Œæˆï¼Œæ‰ä½œ commit writeã€‚

é€™åŠŸèƒ½æ˜¯å¾ 4.0 ä¹‹å¾Œæ‰åŠ å…¥äº†ï¼Œ4.2 ä¹‹å¾Œæ‰ç®—ç©©å®š

> In version 4.0, MongoDB supports multi-document transactions on replica sets.

> In version 4.2, MongoDB introduces distributed transactions, which adds support for multi-document transactions on sharded clusters and incorporates the existing support for multi-document transactions on replica sets.

ä¸éé‡åˆ°æœ¬åœ°é–‹ç™¼çš„å•é¡Œï¼Œå› ç‚ºä½ å¿…é ˆè¦èµ·ä¸€å€‹å¢é›†æ‰èƒ½æ¸¬è©¦ï¼Œä¸ç„¶ä½ æœƒçœ‹åˆ°é€™å€‹éŒ¯èª¤è¨Šæ¯

> MongoError: Transaction numbers are only allowed on a replica set member or mongos

é€™ä¹Ÿæ˜¯æœ¬æ–‡è¦è§£æ±ºçš„å•é¡Œ

ç°¡å–®çš„è§£æ³•å¯ä»¥åƒè€ƒé€™ç¯‡æ–‡ç«  - [Introducing run-rs, a Zero Config MongoDB Replica Set Runner](http://thecodebarbarian.com/introducing-run-rs-zero-config-mongodb-runner.html)ï¼Œé€™æ˜¯è©²æ–‡ä½œè€…æä¾›çš„ä¸€å€‹æ–¹ä¾¿çš„å·¥å…· - [run-rs](https://www.npmjs.com/package/run-rs)ï¼Œèƒ½ç°¡å–®åœ¨æœ¬åœ°èµ·ä¸€å€‹ MongoDB å¢é›†ã€‚ä¸éå¦‚æœä½ çš„é–‹ç™¼ç’°å¢ƒæ˜¯ä»¥ container ç‚ºä¸»çš„è©±åˆä¸è¡Œäº†...0rz

æ‰€ä»¥å¾Œä¾†åˆæ‰¾åˆ°äº† [**MongoDBÂ® packaged by Bitnami**](https://github.com/bitnami/bitnami-docker-mongodb)ï¼ŒBitnami é€™åå­—æ‡‰è©²æœ‰äº›é–‹ç™¼è€…æœƒæœ‰é»å°è±¡ï¼Œæ‰€ä»¥é€™å°ˆæ¡ˆæœ‰æœ¬å®¶çš„ç²¾ç¥å­˜åœ¨ ğŸ˜ï¼Œå¯ä»¥æ–¹ä¾¿èµ·ä¸€å€‹ MongoDB å¢é›†ï¼ŒåŸºæœ¬ä¸Šéœ€è¦çš„è³‡è¨Šéƒ½åœ¨é€™å€‹[æ®µè½](https://github.com/bitnami/bitnami-docker-mongodb#setting-up-replication)å¯ä»¥æ‰¾åˆ°ã€‚

[é€™é‚Šæ˜¯ç°¡å–®çš„ docker-compose ç¯„ä¾‹](https://gist.github.com/siygle/3d5618863679b468f5865e1b41a6ea7d)ï¼Œå¯ä»¥ç°¡å–®èµ·å¥½éœ€è¦çš„ç’°å¢ƒï¼š

ä¹Ÿå¯ä»¥ç”¨ç°¡å–®çš„æ–¹å¼é€£é€² DB å»çœ‹è£¡é¢çš„è³‡æ–™

```jsx
mongo --host localhost --port 27017 --username pguser --password 12345 dev_staging
```

ä»¥ä¸Šï¼Œæ”¶å·¥ï¼
è‡³æ–¼å„èªè¨€æ€éº¼å¯¦ä½œï¼Œå¤§å®¶å°±ç›´æ¥åƒè€ƒå®˜æ–¹æ–‡ä»¶å§ ğŸ˜™
