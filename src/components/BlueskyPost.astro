---
import type { BlueskyPost } from '~/lib/bluesky';
import { renderRichText, formatRelativeTime, getPostUrl } from '~/lib/bluesky';

interface Props {
  post: BlueskyPost;
  isInThread?: boolean;
  showConnector?: boolean;
  showDate?: boolean;
}

const { post, isInThread = false, showConnector = false, showDate = false } = Astro.props;
const postUrl = getPostUrl(post.uri, post.author.handle);
const displayName = post.author.displayName || post.author.handle;

// Format the full date for display
function formatPostDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
  });
}

// Process embed data
const embed = post.embed;
const hasImages = embed?.$type === 'app.bsky.embed.images#view' && embed.images;
const hasExternal = embed?.$type === 'app.bsky.embed.external#view' && embed.external;
const hasQuote = embed?.$type === 'app.bsky.embed.record#view' && embed.record;
const hasRecordWithMedia = embed?.$type === 'app.bsky.embed.recordWithMedia#view';
---

<article class:list={[
  "relative",
  isInThread ? "pl-12" : "bg-white border border-gray-200 rounded-lg p-4 hover:border-gray-300 transition-colors"
]}>
  {showConnector && (
    <div class="absolute left-5 top-0 bottom-0 w-0.5 bg-gray-200" />
  )}

  {isInThread && (
    <div class="absolute left-5 top-5 w-5 h-5 -translate-x-1/2">
      <div class="w-2 h-2 rounded-full bg-gray-300" />
    </div>
  )}

  <div class={isInThread ? "bg-white border border-gray-200 rounded-lg p-4" : ""}>
    <!-- Post date -->
    {showDate && !isInThread && (
      <div class="text-xs text-gray-400 mb-2">
        {formatPostDate(post.record.createdAt)}
      </div>
    )}

    <!-- Author header -->
    <div class="flex items-start gap-3 mb-3">
      {post.author.avatar ? (
        <img
          src={post.author.avatar}
          alt={displayName}
          class="w-10 h-10 rounded-full flex-shrink-0"
          loading="lazy"
        />
      ) : (
        <div class="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0" />
      )}
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="font-medium text-gray-900 truncate">{displayName}</span>
          <span class="text-sm text-gray-500 truncate">@{post.author.handle}</span>
        </div>
      </div>
      <a
        href={postUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="text-sm text-gray-400 hover:text-teal-600 flex-shrink-0"
        title="View on Bluesky"
      >
        {formatRelativeTime(post.record.createdAt)}
      </a>
    </div>

    <!-- Post content -->
    {post.record.text && (
      <div
        class="prose prose-sm max-w-none mb-3 text-gray-800 whitespace-pre-wrap break-words"
        set:html={renderRichText(post.record.text, post.record.facets)}
      />
    )}

    <!-- Embedded images -->
    {hasImages && embed.images && (
      <div class:list={[
        "mt-3 rounded-lg overflow-hidden",
        embed.images.length === 1 ? "" : "grid gap-1",
        embed.images.length === 2 ? "grid-cols-2" : "",
        embed.images.length >= 3 ? "grid-cols-2" : ""
      ]}>
        {embed.images.map((img, i) => (
          <a
            href={img.fullsize}
            target="_blank"
            rel="noopener noreferrer"
            class:list={[
              "block overflow-hidden",
              embed.images!.length === 3 && i === 0 ? "row-span-2" : ""
            ]}
          >
            <img
              src={img.thumb}
              alt={img.alt || 'Image'}
              class="w-full h-full object-cover hover:opacity-90 transition-opacity"
              style={img.aspectRatio ? `aspect-ratio: ${img.aspectRatio.width}/${img.aspectRatio.height}` : 'aspect-ratio: 16/9'}
              loading="lazy"
            />
          </a>
        ))}
      </div>
    )}

    <!-- External link embed -->
    {hasExternal && embed.external && (
      <a
        href={embed.external.uri}
        target="_blank"
        rel="noopener noreferrer"
        class="mt-3 block border border-gray-200 rounded-lg overflow-hidden hover:border-gray-300 transition-colors"
      >
        {embed.external.thumb && (
          <img
            src={embed.external.thumb}
            alt=""
            class="w-full h-32 object-cover"
            loading="lazy"
          />
        )}
        <div class="p-3">
          <p class="font-medium text-gray-900 text-sm line-clamp-1">{embed.external.title}</p>
          {embed.external.description && (
            <p class="text-gray-600 text-sm mt-1 line-clamp-2">{embed.external.description}</p>
          )}
          <p class="text-gray-400 text-xs mt-1">{new URL(embed.external.uri).hostname}</p>
        </div>
      </a>
    )}

    <!-- Quote post embed -->
    {hasQuote && embed.record && embed.record.value && (
      <div class="mt-3 border border-gray-200 rounded-lg p-3 bg-gray-50">
        <div class="flex items-center gap-2 mb-2">
          <span class="font-medium text-gray-900 text-sm">
            {embed.record.author?.displayName || embed.record.author?.handle}
          </span>
          <span class="text-gray-500 text-sm">@{embed.record.author?.handle}</span>
        </div>
        <p class="text-gray-700 text-sm line-clamp-3">{embed.record.value.text}</p>
      </div>
    )}

    <!-- Engagement metrics (single link to post) -->
    <a
      href={postUrl}
      target="_blank"
      rel="noopener noreferrer"
      class="flex items-center gap-4 mt-4 text-sm text-gray-400 hover:text-gray-600 transition-colors"
      title="View on Bluesky"
    >
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        {post.replyCount}
      </span>
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        {post.repostCount}
      </span>
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
        {post.likeCount}
      </span>
    </a>
  </div>
</article>
